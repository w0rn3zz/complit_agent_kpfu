"""Агент для конвертации аббревиатур в полные слова"""
import logging
from typing import Optional

from src.core.clients.gigachat_client import GigaChatClient

logger = logging.getLogger(__name__)


class AbbreviationConvertAgent:
    """
    Агент для обработки аббревиатур в тексте заявки.
    Использует GigaChat для расшифровки сокращений.
    """
    
    def __init__(self):
        self.gigachat_client = GigaChatClient()
        self.system_prompt = """Ты - эксперт по аббревиатурам и сокращениям в контексте университета КФУ (Казанский федеральный университет).

Твоя задача:
1. Найти все аббревиатуры и сокращения в тексте
2. Расшифровать их в полные слова/фразы
3. Вернуть исправленный текст

Известные аббревиатуры КФУ:
- ИТИС - Институт вычислительной математики и информационных технологий
- ИВМиИТ - Институт вычислительной математики и информационных технологий  
- ИЭУиФ - Институт экономики и финансов
- ИФМиБ - Институт фундаментальной медицины и биологии
- ПП Парус - Программный продукт Парус (система учета)
- ИАС - Информационно-аналитическая система
- ОС - Операционная система
- ПО - Программное обеспечение
- ЭЦП - Электронная цифровая подпись

Если аббревиатура неизвестна или неоднозначна - оставь как есть.

Верни ТОЛЬКО исправленный текст, без дополнительных комментариев."""
    
    async def process(self, text: str) -> str:
        """
        Обработка текста заявки - замена аббревиатур на полные слова
        
        Args:
            text: Исходный текст заявки
            
        Returns:
            Текст с расшифрованными аббревиатурами
        """
        try:
            logger.info(f"Обработка аббревиатур в тексте: {text[:100]}...")
            
            # Отправляем запрос в GigaChat
            processed_text = await self.gigachat_client.generate_response(
                system_prompt=self.system_prompt,
                user_prompt=f"Текст заявки:\n\n{text}",
                temperature=0.3,  # Низкая температура для более точных результатов
                max_tokens=512
            )
            
            # ВАЖНО: если GigaChat вернул ошибку - используем исходный текст!
            if "ошибка" in processed_text.lower() or "error" in processed_text.lower():
                logger.warning("GigaChat вернул ошибку, используем исходный текст")
                return text
            
            logger.info(f"Текст после обработки: {processed_text[:100]}...")
            return processed_text.strip()
            
        except Exception as e:
            logger.error(f"Ошибка при обработке аббревиатур: {e}")
            # В случае ошибки возвращаем исходный текст
            return text
